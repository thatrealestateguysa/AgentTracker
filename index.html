<!doctype html>

if (Array.isArray(data.statuses) && data.statuses.length) STATUSES = data.statuses;
renderStatusOptions();
} catch(err){
renderStatusOptions();
showMsg('Could not load statuses, using defaults.');
}
}

async function refresh(){
try{
const data = await callAPI({ action: 'list' });
if(!data.ok && !data.data) throw new Error(data.error||'List failed');
if (Array.isArray(data.statuses) && data.statuses.length) STATUSES = data.statuses;
ROWS = data.data || [];
renderStatusOptions();
render();
}catch(err){
showMsg('Load error: '+err.message);
}
}

function render(){
const term = (document.getElementById('search').value || '').toLowerCase();
const tbody = document.querySelector('#tbl tbody');
tbody.innerHTML = '';
const filtered = ROWS.filter(r => {
const hay = `${r.propertyAddress} ${r.ownerName} ${r.ownerSurname} ${r.ownerEmail} ${r.ownerContact}`.toLowerCase();
return hay.includes(term);
});
for (const r of filtered){
const tr = document.createElement('tr');
tr.innerHTML = `
<td>${escapeHtml(r.propertyAddress)}</td>
<td>${escapeHtml(r.ownerName)} ${escapeHtml(r.ownerSurname)}</td>
<td>${escapeHtml(r.ownerContact)}</td>
<td>${escapeHtml(r.ownerEmail)}</td>
<td>${statusCell(r)}</td>
`;
tbody.appendChild(tr);
}
}

function statusCell(r){
const opts = (STATUSES.length ? STATUSES : DEFAULT_STATUSES)
.map(s => `<option value="${s}" ${s===r.status?'selected':''}>${s}</option>`).join('');
return `<select data-row="${r.row}" onchange="updateStatus(this)">${opts}</select>`;
}

async function updateStatus(sel){
const row = sel.getAttribute('data-row');
const status = sel.value;
try{
const data = await callAPI({ action:'updateStatus', row, status });
if (!data.ok){ throw new Error(data.error||'Update failed'); }
const idx = ROWS.findIndex(x => String(x.row) === String(row));
if (idx > -1) ROWS[idx].status = status;
}catch(err){
showMsg('Update failed: '+err.message);
}
}

async function addRecord(){
const payload = {
action: 'add',
propertyAddress: document.getElementById('addr').value.trim(),
ownerName: document.getElementById('name').value.trim(),
ownerSurname: document.getElementById('surname').value.trim(),
ownerContact: document.getElementById('phone').value.trim(),
ownerEmail: document.getElementById('email').value.trim(),
status: document.getElementById('status').value
};
if (!payload.propertyAddress){ showMsg('Property Address is required.'); return; }
try{
const data = await callAPI(payload);
if (!data.ok){ throw new Error(data.error||'Add failed'); }
document.getElementById('addr').value = '';
document.getElementById('name').value = '';
document.getElementById('surname').value = '';
document.getElementById('phone').value = '';
document.getElementById('email').value = '';
await refresh();
showMsg('Record added.', true);
}catch(err){
showMsg('Add failed: '+err.message);
}
}

function escapeHtml(s){
return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));
}

// Boot
document.getElementById('search').addEventListener('input', render);
document.addEventListener('DOMContentLoaded', async () => {
renderStatusOptions();
await loadStatuses();
await refresh();
});
</script>
</body>
</html>
