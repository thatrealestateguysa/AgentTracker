<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Tracker</title>
  <style>
    :root{--bg:#0f0f10;--panel:#18181b;--muted:#c9c9cf;--line:#2a2a30;--text:#f4f4f5;--kw:#c70000}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;max-width:1100px;margin:24px auto;padding:0 16px;background:var(--bg);color:var(--text)}
    h1{margin:0 0 12px;font-size:24px}
    .card{background:var(--panel);border-radius:16px;padding:16px 18px;margin:16px 0;box-shadow:0 2px 12px rgba(0,0,0,.28)}
    label{display:block;margin:8px 0 4px;font-size:13px;color:var(--muted)}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0d0d10;color:#fff}
    button{cursor:pointer;font-weight:600}
    button.primary{background:var(--kw);border-color:var(--kw)}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .grid .span-2{grid-column:span 2}
    .grid .span-3{grid-column:span 3}
    .grid .span-6{grid-column:span 6}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .toolbar{display:flex;gap:10px;align-items:center;margin:10px 0}
    .right{margin-left:auto}
    .msg{margin:8px 0;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
    .msg.error{border-color:#7a1f1f;background:#2a0f10}
    .msg.ok{border-color:#1f7a42;background:#0f2a16}
  </style>
</head>
<body>
  <h1>Agent Tracker</h1>

  <div class="card">
    <div class="toolbar">
      <input id="search" placeholder="Search by address, owner, email or phone" />
      <button class="right" onclick="refresh()">Reload</button>
      <button onclick="initialize()">Initialize</button>
    </div>

    <div id="alert" class="msg" style="display:none"></div>

    <div class="grid">
      <div class="span-3">
        <label>Property Address</label>
        <input id="addr" />
      </div>
      <div>
        <label>Owner's Name</label>
        <input id="name" />
      </div>
      <div>
        <label>Owner's Surname</label>
        <input id="surname" />
      </div>
      <div>
        <label>Owner's Contact Number</label>
        <input id="phone" />
      </div>
      <div class="span-2">
        <label>Owner's Email Address</label>
        <input id="email" />
      </div>
      <div>
        <label>Status</label>
        <select id="status"></select>
      </div>
      <div class="span-6">
        <button class="primary" onclick="addRecord()">Add Record</button>
      </div>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Property Address</th>
          <th>Owner</th>
          <th>Contact</th>
          <th>Email</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Primary API (Netlify function). If unavailable, we fall back to direct Apps Script URL.
    const PROXY_API = '/.netlify/functions/proxy';
    const GAS_FALLBACK = 'https://script.google.com/macros/s/AKfycbyePYFbmifd9UVbYIRMmgfw-hEzEIW5ct-g2I1uE8Dp2F6Uvo3kZfyiRQlHuxuovBeeWg/exec';

    const DEFAULT_STATUSES = [
      'Generated Lead',
      'Appointment Made',
      'CMA Sent',
      'Listing Appointment Held',
      'Second Listing Appointment',
      'Listed',
      'Buyer Showings',
      'Offer to Purchase',
      'Bond Approved',
      'Transaction Lodged',
      'Transaction On Prep',
      'Transaction Registered'
    ];

    let STATUSES = [...DEFAULT_STATUSES];
    let ROWS = [];

    function qs(obj){
      return Object.entries(obj)
        .filter(([,v]) => v !== undefined && v !== null)
        .map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join('&');
    }

    function showMsg(text, ok=false){
      const el = document.getElementById('alert');
      if(!text){ el.style.display='none'; el.className='msg'; el.textContent=''; return; }
      el.textContent = text;
      el.className = 'msg ' + (ok? 'ok':'error');
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, 4500);
    }

    async function fetchJSON(url){
      const res = await fetch(url, { method: 'GET' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const txt = await res.text();
      try { return JSON.parse(txt); }
      catch { throw new Error('Invalid JSON from API'); }
    }

    async function callAPI(params){
      const q = qs(params);
      // Try proxy first
      try { return await fetchJSON(`${PROXY_API}?${q}`); }
      catch (e1) {
        // Fallback to direct Apps Script
        try {
          const data = await fetchJSON(`${GAS_FALLBACK}?${q}`);
          showMsg('Connected via fallback (direct Apps Script).', true);
          return data;
        } catch (e2) {
          throw e2;
        }
      }
    }

    async function initialize(){
      try{
        const data = await callAPI({ action: 'init' });
        if(!data.ok) throw new Error(data.error||'Init failed');
        if (Array.isArray(data.statuses) && data.statuses.length) STATUSES = data.statuses;
        renderStatusOptions();
        await refresh();
        showMsg('Sheet initialized and statuses loaded.', true);
      }catch(err){
        showMsg('Initialize error: '+err.message);
      }
    }

    function renderStatusOptions(){
      const sel = document.getElementById('status');
      sel.innerHTML = (STATUSES.length? STATUSES: DEFAULT_STATUSES)
        .map(s => `<option value="${s}">${s}</option>`).join('');
    }

    async function loadStatuses(){
      try{
        const data = await callAPI({ action: 'statuses' });
        if (Array.isArray(data.statuses) && data.statuses.length) STATUSES = data.statuses;
        renderStatusOptions();
      } catch(err){
        // Keep defaults but inform
        renderStatusOptions();
        showMsg('Could not load statuses, using defaults.');
      }
    }

    async function refresh(){
      try{
        const data = await callAPI({ action: 'list' });
        if(!data.ok && !data.data) throw new Error(data.error||'List failed');
        if (Array.isArray(data.statuses) && data.statuses.length) STATUSES = data.statuses;
        ROWS = data.data || [];
        renderStatusOptions();
        render();
      }catch(err){
        showMsg('Load error: '+err.message);
      }
    }

    function render(){
      const term = (document.getElementById('search').value || '').toLowerCase();
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      const filtered = ROWS.filter(r => {
        const hay = `${r.propertyAddress} ${r.ownerName} ${r.ownerSurname} ${r.ownerEmail} ${r.ownerContact}`.toLowerCase();
        return hay.includes(term);
      });
      for (const r of filtered){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.propertyAddress)}</td>
          <td>${escapeHtml(r.ownerName)} ${escapeHtml(r.ownerSurname)}</td>
          <td>${escapeHtml(r.ownerContact)}</td>
          <td>${escapeHtml(r.ownerEmail)}</td>
          <td>${statusCell(r)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function statusCell(r){
      const opts = (STATUSES.length ? STATUSES : DEFAULT_STATUSES)
        .map(s => `<option value="${s}" ${s===r.status?'selected':''}>${s}</option>`).join('');
      return `<select data-row="${r.row}" onchange="updateStatus(this)">${opts}</select>`;
    }

    async function updateStatus(sel){
      const row = sel.getAttribute('data-row');
      const status = sel.value;
      try{
        const data = await callAPI({ action:'updateStatus', row, status });
        if (!data.ok){ throw new Error(data.error||'Update failed'); }
        const idx = ROWS.findIndex(x => String(x.row) === String(row));
        if (idx > -1) ROWS[idx].status = status;
      }catch(err){
        showMsg('Update failed: '+err.message);
      }
    }

    async function addRecord(){
      const payload = {
        action: 'add',
        propertyAddress: document.getElementById('addr').value.trim(),
        ownerName: document.getElementById('name').value.trim(),
        ownerSurname: document.getElementById('surname').value.trim(),
        ownerContact: document.getElementById('phone').value.trim(),
        ownerEmail: document.getElementById('email').value.trim(),
        status: document.getElementById('status').value
      };
      if (!payload.propertyAddress){ showMsg('Property Address is required.'); return; }
      try{
        const data = await callAPI(payload);
        if (!data.ok){ throw new Error(data.error||'Add failed'); }
        document.getElementById('addr').value = '';
        document.getElementById('name').value = '';
        document.getElementById('surname').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('email').value = '';
        await refresh();
        showMsg('Record added.', true);
      }catch(err){
        showMsg('Add failed: '+err.message);
      }
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));
    }

    // Boot
    document.getElementById('search').addEventListener('input', render);
    (async () => { renderStatusOptions(); await loadStatuses(); await refresh(); })();
  </script>
</body>
</html>
